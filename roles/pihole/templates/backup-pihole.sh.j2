#!/bin/bash
set -euo pipefail

SCRIPT_NAME="{{ container_name }}"
source /usr/local/lib/backup-lib.sh

DEST_FOLDER="{{ backups_dir }}/{{ container_name }}"
TIMESTAMP=$(date +'%F_%H%M')
DEST_FILE="{{ container_name }}-backup-${TIMESTAMP}.tar.gz"
DATA_DIR="{{ docker_dir }}/{{ container_name }}"

log "Starting backup."

# Pre-flight checks
check_disk_space "{{ backups_dir }}"
check_nas
require_dir "$DEST_FOLDER"

# Tar config directories from host bind mount â€” no container downtime needed.
# Exclude pihole-FTL.db (large query history database, not config).
log "Creating archive of pihole config..."
sudo /bin/tar -czf "$DEST_FOLDER/$DEST_FILE" \
    --exclude="${DATA_DIR}/etc-pihole/pihole-FTL.db" \
    "${DATA_DIR}/etc-pihole" \
    "${DATA_DIR}/etc-dnsmasq.d" \
    || die "Archive failed."

verify_backup_file "$DEST_FOLDER/$DEST_FILE"

find "$DEST_FOLDER" -name "*.tar.gz" -mtime +98 -delete
log "Old backups pruned."

log "Syncing to NAS..."
rsync -az --delete "$DEST_FOLDER/" "nas:/volume1/backups/{{ container_name }}" \
    || die "rsync to NAS failed."

notify_success "{{ container_name }} backed up successfully."
