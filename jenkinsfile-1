pipeline {
  agent { 
        dockerfile{ 
          args '-v /home/pi/.ssh:/var/jenkins_home/workspace/home-services-ansible-automaton/.ssh:ro'
        }
  }
  environment {
    VAULT_PW = credentials('vaultpw')
  }
  stages {
    stage('Test') {
      steps {
        script {
            env.DEFAULT_LOCAL_TMP = env.WORKSPACE_TMP
            env.HOME = env.WORKSPACE

            sh """
            whoami
            ls -al ~
            ls -al ~/.ssh
            ansible-playbook -i inventory --vault-password-file "$VAULT_PW" site.yml --tags setup-nas-for-backups --private-key /home/pi/.ssh/ed25519_backup_pi
            """
        }
      }
    }
  }
}